<wxs module="styleUtils">
  var getTaskStyle = function(task) {
    return 'top:' + task.top + 'px;' + 
           'height:' + (task.height - 2) + 'px;' + 
           'background-color:' + task.displayColor + ';' + 
           'left:calc(' + task.left + '% + 3px);' + 
           'width:calc(' + task.width + '% - 6px);';
  }
  var formatTime = function(str) {
    if (!str) return '';
    return str.replace('T', ' '); // å°† T æ›¿æ¢ä¸ºç©ºæ ¼
  }

  // å¯¼å‡ºä¸¤ä¸ªå‡½æ•°
  module.exports = {
    getTaskStyle: getTaskStyle,
    formatTime: formatTime
  }
</wxs>
<view class="page">
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <view class="hero">
    <view class="hero-top">
      <text class="time-text">{{year}}/{{month}}/{{selectedDay || weekDays[0].day}}</text>
      <text class="week-text">ç¬¬{{weekOfYear}}å‘¨</text>
    </view>
    <view class="hero-actions">
      <view class="icon-btn member-btn" bindtap="toggleMemberSelector">
        <text class="member-icon">ğŸ‘¤</text>
        <text class="member-label">{{getViewMemberName()}}</text>
      </view>
      
      <view class="icon-btn" bindtap="onBackToToday">ä»Šå¤©</view>
      
      <view class="icon-btn" bindtap="onStatistics">ç»Ÿè®¡</view>
      
      <view class="icon-btn primary" bindtap="onAdd">+ æ·»åŠ </view>
    </view>
  </view>

  <!-- å‘¨è§†å›¾è¡¨æ ¼ -->
  <view class="schedule-container" 
        bindtouchstart="onTouchStart" 
        bindtouchend="onTouchEnd">
    
    <!-- æ—¥æœŸè¡Œ -->
    <view class="date-header">
      <view class="time-column-header">
        <text class="month-label">{{month}}æœˆ</text>
      </view>
      <view class="day-item" 
            wx:for="{{weekDays}}" 
            wx:key="day"
            data-full-date="{{item.fullDate}}"
            bindtap="onDateTap">
        <text class="day-label">{{item.label}}</text>
        <view class="day-number {{item.day === selectedDay ? 'active' : ''}} {{item.fullDate === todayDateStr ? 'today' : ''}}">
          {{item.day}}
        </view>
      </view>
    </view>

    <!-- æ—¶é—´æ ¼å­ -->
    <scroll-view class="schedule-body" scroll-y enhanced show-scrollbar="{{false}}">
      <view class="schedule-grid">
        <!-- æ¯ä¸ªæ—¶é—´æ®µè¡Œ -->
        <view class="time-row" wx:for="{{timeSlots}}" wx:key="id" wx:for-item="slot">
          <!-- æ—¶é—´æ ‡ç­¾ -->
          <view class="time-cell">
            <text class="slot-label">{{slot.label}}</text>
            <text class="slot-time">{{slot.start}}</text>
            <text class="slot-time">{{slot.end}}</text>
          </view>
          
          <!-- æ¯å¤©çš„æ ¼å­ -->
          <view class="day-cell" wx:for="{{weekDays}}" wx:key="day" wx:for-item="dayItem" wx:for-index="dayIdx">
            <!-- æ£€æŸ¥æ˜¯å¦æœ‰ä»»åŠ¡ -->
            <block wx:for="{{tasks}}" wx:key="id" wx:for-item="task">
              <block wx:if="{{task.dayIndex === dayIdx && task.startSlotId === slot.id}}">
                <view class="task-block" 
                  style="top: {{task.top}}px; height: {{task.height - 2}}px; background-color: {{task.displayColor}}; "
                  data-task-id="{{task.id}}"
                  catchtap="onEventTap">
                  <!-- å¤åˆäº‹åŠ¡æ ‡è®°æ”¾åœ¨æœ€å‰é¢ -->
                  <text class="task-title">
                    <text wx:if="{{task.isSubTaskBlock}}" class="composite-icon">ğŸ”—</text>{{task.isSubTaskBlock ? task.subTaskTitle : task.title}}
                  </text>
                  <text class="task-location" wx:if="{{task.content && !task.isSubTaskBlock}}">{{task.content}}</text>
                  <view class="task-status" wx:if="{{task.isCompleted}}">
                    <text class="status-icon">âœ“</text>
                  </view>
                </view>
              </block>
            </block>
          </view>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- å‘¨åˆ‡æ¢æç¤º -->
  <view class="week-nav">
    <view class="nav-btn" bindtap="onPrevWeek">
      <text>â€¹ ä¸Šå‘¨</text>
    </view>
    <view class="nav-btn" bindtap="onNextWeek">
      <text>ä¸‹å‘¨ â€º</text>
    </view>
  </view>

  <!-- å®¶åº­æˆå‘˜é€‰æ‹©å™¨å¼¹çª— -->
  <view class="popup-mask" wx:if="{{showMemberSelector}}" bindtap="closeMemberSelector"></view>
  <view class="member-selector-popup" wx:if="{{showMemberSelector}}">
    <view class="popup-header">
      <text class="popup-title">é€‰æ‹©æŸ¥çœ‹æˆå‘˜</text>
      <view class="popup-close" bindtap="closeMemberSelector">Ã—</view>
    </view>
    <scroll-view class="member-list" scroll-y>
      <view class="member-item {{viewUserId === item.userId ? 'selected' : ''}}" 
            wx:for="{{familyMembers}}" 
            wx:key="userId"
            data-user-id="{{item.userId}}"
            bindtap="onSelectMember">
        <view class="member-avatar" style="background: {{viewUserId === item.userId ? '#4a90d9' : '#8aa4c8'}};">
          {{item.name[0]}}
        </view>
        <view class="member-info">
          <text class="member-name">{{item.name}}</text>
          <text class="member-role">{{item.role}}</text>
        </view>
        <view class="member-check" wx:if="{{viewUserId === item.userId}}">
          <text>âœ“</text>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- ä»»åŠ¡è¯¦æƒ…å¼¹çª— -->
  <view class="popup-mask" wx:if="{{showDetail}}" bindtap="closeDetail"></view>
  <view class="popup" wx:if="{{showDetail}}">
    <view class="popup-header">
      <view class="popup-title-row">
        <view class="type-dot" style="background-color: {{detail.displayColor}}"></view>
        <text class="popup-title">{{detail.displayTitle || detail.title}}</text>
      </view>
      <view class="status-badge {{detail.status === 'DONE' ? 'done' : detail.status === 'DOING' ? 'doing' : ''}}">
        {{statusText[detail.status]}}
      </view>
    </view>
    
    <view class="popup-content">
      
      <view class="popup-row">
        <text class="text">æ—¶é—´ï¼š</text>
        <text class="popup-text">{{styleUtils.formatTime(detail.beginTime)}} - {{styleUtils.formatTime(detail.endTime)}}</text>
      </view>
      <view class="popup-row" wx:if="{{detail.content}}">
        <text class="text">æè¿°ï¼š</text>
        <text class="popup-text">{{detail.content}}</text>
      </view>
      <view class="popup-row" wx:if="{{detail.participants && detail.participants.length > 0}}">
        <text class="text">å‚ä¸äººå‘˜</text>
        <text class="popup-text">
          <block wx:for="{{detail.participants}}" wx:key="userId">
            {{item.name}}{{index < detail.participants.length - 1 ? 'ã€' : ''}}
          </block>
        </text>
      </view>
      <view class="popup-row" wx:if="{{detail.isComposite}}">
        <text class="icon">ğŸ”—</text>
        <text class="popup-text">å¤åˆä»»åŠ¡ (è¿›åº¦: {{detail.progress || 0}}%)</text>
      </view>
    </view>
    
    <view class="popup-actions">
      <button class="action-btn detail-btn" bindtap="onViewDetail">è¯¦æƒ…</button>
      <button class="action-btn edit-btn" bindtap="onEdit">ç¼–è¾‘</button>
      <button class="action-btn status-btn" 
              bindtap="onToggleStatus" 
              wx:if="{{!detail.isComposite}}">
        {{detail.status === 'DONE' ? 'æ ‡è®°æœªå®Œæˆ' : 'æ ‡è®°å®Œæˆ'}}
      </button>
      <button class="action-btn delete-btn" bindtap="onDelete">åˆ é™¤</button>
    </view>
  </view>
</view>
<custom-tabbar/>
