<view class="container">
  <!-- top summary removed to avoid duplicate card; main user card below serves as primary display -->

  <!-- Rich dashboard cards -->
  <!-- Simplified: show admin info and family members only -->
  <view class="panel">
    <view class="user-card">
      <view class="avatar-circle large">
        <text class="avatar-text large">{{avatarInitials}}</text>
        <view class="role-badge {{user.role === 'admin' ? 'admin' : 'member'}}">{{user.role === 'admin' ? 'å®¶åº­ç®¡ç†å‘˜' : 'å®¶åº­æˆå‘˜'}}</view>
      </view>
      <view class="user-meta">
        <text class="card-title">{{user.name}}</text>
        <text class="card-sub">{{user.email}}</text>
        <text class="card-sub">å®¶åº­ï¼š{{user.familyId || 'â€”'}}</text>
    </view>
  </view>

  <view class="family-section" wx:if="{{user && user.role === 'admin'}}">
    <view class="section-header">
      <text class="section-title">å®¶åº­æˆå‘˜</text>
      <text wx:if="{{user && user.role === 'admin'}}" class="add-btn" bindtap="showAddMemberForm">+ æ·»åŠ æˆå‘˜</text>
    </view>
    <view class="member-list">
        <view wx:if="{{!familyLoaded}}" class="empty">
          <text>æ­£åœ¨åŠ è½½æˆå‘˜...</text>
        </view>
        <block wx:for="{{familyMembers}}" wx:key="id">
          <block wx:if="{{item.id !== user.id}}">
            <view class="member-item" bindtap="onMemberTap" data-id="{{item.id}}">
        <view class="member-avatar">ğŸ‘¤</view>
        <view class="member-info">
          <text class="member-name">{{item.name}}</text>
          <text class="member-email">{{item.email}}</text>
        </view>
            <view class="member-controls">
        <text class="member-role">{{item.role === 'admin' ? 'ç®¡ç†å‘˜' : 'æˆå‘˜'}}</text>
                <!-- admin taps the member card to open inline permission editor -->
              </view>
      </view>
            <!-- inline vertical permission editor shown when member is selected -->
            <view wx:if="{{selectedMemberId === item.id && user && user.role === 'admin'}}" class="perm-panel-vertical">
              <view class="perm-row">
                <text class="perm-label">äº‹åŠ¡</text>
                <switch checked="{{item.permissions && item.permissions.tasks}}" data-id="{{item.id}}" data-key="tasks" bindchange="onPermToggle"/>
              </view>
              <view class="perm-row">
                <text class="perm-label">å¥åº·</text>
                <switch checked="{{item.permissions && item.permissions.health}}" data-id="{{item.id}}" data-key="health" bindchange="onPermToggle"/>
              </view>
              <view class="perm-row">
                <text class="perm-label">è´¢åŠ¡</text>
                <switch checked="{{item.permissions && item.permissions.finance}}" data-id="{{item.id}}" data-key="finance" bindchange="onPermToggle"/>
              </view>
            </view>
          </block>
        </block>
        <view wx:if="{{familyLoaded && familyMembers.length === 0}}" class="empty">
        <text>æš‚æ— å®¶åº­æˆå‘˜</text>
        </view>
      </view>
    </view>
  </view>

  <!-- æ·»åŠ æˆå‘˜å¼¹çª— -->
  <view class="modal-mask" wx:if="{{showAddMember}}" bindtap="hideAddMemberForm"></view>
  <view class="modal" wx:if="{{showAddMember}}">
    <view class="modal-content" bindtap="">
      <view class="modal-title">æ·»åŠ å®¶åº­æˆå‘˜</view>

      <view class="input-group">
        <text class="label">é‚®ç®±</text>
        <view class="input-box">
          <input class="input" placeholder="è¯·è¾“å…¥æˆå‘˜é‚®ç®±" value="{{memberEmail}}" bindinput="onMemberEmail" />
        </view>
      </view>

  <!-- inline editor used instead of modal -->

      <view class="input-group">
        <text class="label">å¯†ç </text>
        <view class="input-box password-box">
          <input class="input" placeholder="è¯·è¾“å…¥æˆå‘˜å¯†ç " password="{{!memberShowPwd}}" value="{{memberPassword}}" bindinput="onMemberPassword" />
          <text class="eye" bindtap="toggleMemberPwd">{{memberShowPwd ? 'ğŸ™ˆ' : 'ğŸ‘ï¸'}}</text>
        </view>
      </view>

      <view class="input-group">
        <text class="label">å§“å</text>
        <view class="input-box">
          <input class="input" placeholder="è¯·è¾“å…¥æˆå‘˜å§“å" value="{{memberName}}" bindinput="onMemberName" />
        </view>
      </view>

      <view class="modal-actions">
        <button class="btn cancel" bindtap="hideAddMemberForm">å–æ¶ˆ</button>
        <button class="btn confirm" bindtap="addMember">æ·»åŠ </button>
      </view>
    </view>
  </view>

  <view class="menu-list">
    <view class="menu-item" bindtap="onLogout">
      <text class="menu-text">é€€å‡ºç™»å½•</text>
      <text class="menu-arrow">></text>
    </view>
  </view>
  <custom-tabbar/>
</view>
